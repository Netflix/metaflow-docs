<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-153346743-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Metaflow Docs" href="/opensearch.xml"><title data-react-helmet="true">Testing Philosophy | Metaflow Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://docs.metaflow.org/img/Metaflow_Logo_Vertical_FullColor_Ribbon_Dark_RGB.png"><meta data-react-helmet="true" name="twitter:image" content="https://docs.metaflow.org/img/Metaflow_Logo_Vertical_FullColor_Ribbon_Dark_RGB.png"><meta data-react-helmet="true" property="og:url" content="https://docs.metaflow.org/python/internals-of-metaflow/testing-philosophy"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Testing Philosophy | Metaflow Docs"><meta data-react-helmet="true" name="description" content="Watch this talk for motivation: Autonomous Testing and the Future of Software Development by Will Wilson."><meta data-react-helmet="true" property="og:description" content="Watch this talk for motivation: Autonomous Testing and the Future of Software Development by Will Wilson."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.metaflow.org/python/internals-of-metaflow/testing-philosophy"><link data-react-helmet="true" rel="alternate" href="https://docs.metaflow.org/python/internals-of-metaflow/testing-philosophy" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.metaflow.org/python/internals-of-metaflow/testing-philosophy" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://5IZ8L9TJQL-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.e4a54381.css">
<link rel="preload" href="/assets/js/runtime~main.d33b45f4.js" as="script">
<link rel="preload" href="/assets/js/main.18225576.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_aKYr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="64px"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="64px"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/">Python Docs</a><a class="navbar__item navbar__link" href="/r">R Docs</a><a href="https://admin-docs.metaflow.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Admin Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y sidebarWithHideableNavbar_FoYL"><a tabindex="-1" class="sidebarLogo_FJUI" href="/"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="64px"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="64px"></a><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Welcome to Metaflow for Python</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/python/introduction/why-metaflow">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/introduction/why-metaflow">Why Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/introduction/what-is-metaflow">What is Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/introduction/release-notes">Release Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/introduction/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/introduction/contributing-to-metaflow">Contributing to Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/introduction/getting-in-touch">Get in Touch</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/python/getting-started/install">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/install">Installing Metaflow</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/python/getting-started/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/python/getting-started/tutorials/season-1-the-local-experience">Season 1: The Local Experience</a><button aria-label="Toggle the collapsible sidebar category &#x27;Season 1: The Local Experience&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-1-the-local-experience/episode00">Episode 0: Hello World</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-1-the-local-experience/episode01">Episode 1: Playlist</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-1-the-local-experience/episode02">Episode 2: Statistics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-1-the-local-experience/episode03">Episode 3: Playlist Redux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-1-the-local-experience/episode04">Episode 4: Playlist Plus</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/python/getting-started/tutorials/season-2-scaling-out-and-up">Season 2: Scaling Out and Up</a><button aria-label="Toggle the collapsible sidebar category &#x27;Season 2: Scaling Out and Up&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-2-scaling-out-and-up/episode05">Episode 5: Hello AWS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-2-scaling-out-and-up/episode06">Episode 6: Statistics Redux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-2-scaling-out-and-up/episode07">Episode 7: Worldview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/python/getting-started/tutorials/season-2-scaling-out-and-up/episode-8-autopilot">Episode 8: Autopilot</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/python/metaflow-on-aws">Metaflow on AWS</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow-on-aws">Metaflow on AWS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow-on-aws/metaflow-sandbox">Metaflow Sandbox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow-on-aws/deploy-to-aws">Deploying to AWS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/python/metaflow/basics">Developing with Metaflow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/basics">Basics of Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/client">Inspecting Flows and Results</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/python/metaflow/visualizing-results">Visualizing Results</a><button aria-label="Toggle the collapsible sidebar category &#x27;Visualizing Results&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/visualizing-results/effortless-task-inspection-with-default-cards">Effortless Task Inspection with Default Cards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/visualizing-results/easy-custom-reports-with-card-components">Easy Custom Reports with Card Components</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/visualizing-results/advanced-shareable-cards-with-card-templates">Advanced, Shareable Cards with Card Templates</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/debugging">Debugging with Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/scaling">Scaling Out and Up</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/data">Loading and Storing Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/dependencies">Managing External Libraries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/failures">Dealing with Failures</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/metaflow/tagging">Organizing Results</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/python/going-to-production-with-metaflow/scheduling-metaflow-flows">Going to Production with Metaflow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/going-to-production-with-metaflow/scheduling-metaflow-flows">Scheduling Metaflow Flows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/going-to-production-with-metaflow/coordinating-larger-metaflow-projects">Coordinating Larger Metaflow Projects</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/python/internals-of-metaflow/technical-overview">Internals of Metaflow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/python/internals-of-metaflow/technical-overview">Technical Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/python/internals-of-metaflow/testing-philosophy">Testing Philosophy</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Testing Philosophy</h1><p>Watch this talk for motivation: <a href="https://www.youtube.com/watch?v=fFSPwJFXVlw" target="_blank" rel="noopener noreferrer">Autonomous Testing and the Future of Software Development by Will Wilson</a>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="metaflow-test-suite">Metaflow Test Suite<a class="hash-link" href="#metaflow-test-suite" title="Direct link to heading">â€‹</a></h2><p>The integration test harness for the core Metaflow at <code>test/core</code>, generates and executes synthetic Metaflow flows, exercising all aspects of Metaflow. The test suite is executed using <a href="http://tox.readthedocs.io" target="_blank" rel="noopener noreferrer">tox</a> as configured in <code>tox.ini</code>. You can run the tests by hand using <code>pytest</code> or <code>run_tests.py</code> as described below.</p><p>What happens when you execute <code>python helloworld.py run</code>? The execution involves multiple layers of the Metaflow stack. The stack looks like following, starting from the most fundamental layer all the way to the user interface:</p><ol><li>Python interpreter <!-- -->(<code>python2</code>, <code>python3</code>)</li><li>Metaflow core <!-- -->(<code>task.py</code>, <code>runtime.py</code>, <code>datastore</code>, etc.<!-- -->)</li><li>Metaflow plugins <!-- -->(<code>@timeout</code>, <code>@catch</code>, <code>metadata.py</code> etc.<!-- -->)</li><li>User-defined graph</li><li>User-defined step functions</li><li>User interface <!-- -->(<code>cli.py</code>, <code>metaflow.client</code>)</li></ol><p>We could write unit tests for functions in the layers 2, 3, and 6, which would capture some bugs. However, a much larger superset of bugs is caused by unintended interactions across the layers. For instance, exceptions caught by the <code>@catch</code> tag <!-- -->(<!-- -->3<!-- -->)<!-- --> inside a deeply nested foreach graph <!-- -->(<!-- -->4<!-- -->)<!-- --> might not be returned correctly in the client API <!-- -->(<!-- -->6<!-- -->)<!-- --> when using Python 3 <!-- -->(<!-- -->1<!-- -->)<!-- -->.</p><p>The integration test harness included in the <code>core</code> directory tries to surface bugs like this by generating test cases automatically using <em>specifications</em> provided by the developer.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="specifications">Specifications<a class="hash-link" href="#specifications" title="Direct link to heading">â€‹</a></h2><p>The test harness allows you to customize behavior in four ways that correspond to the layers above:</p><ol><li>You define the execution environment, including environment variables, the version of the Python interpreter, and the type of datastore used as <em>contexts</em> in <code>contexts.json</code> <!-- -->(<!-- -->layers 1 and 2<!-- -->)<!-- -->.</li><li>You define the step functions, the decorators used, and the expected results as <code>MetaflowTest</code> templates, stored in the <code>tests</code> directory <!-- -->(<!-- -->layers 3 and 5<!-- -->)<!-- -->.</li><li>You define various graphs that match the step functions as simple JSON descriptions of the graph structure, stored in the <code>graphs</code> directory <!-- -->(<!-- -->layer 4<!-- -->)<!-- -->.</li><li>You define various ways to check the results that correspond to the different user interfaces of Metaflow as <code>MetaflowCheck</code> classes, stored in the <code>metaflow_test</code> directory <!-- -->(<!-- -->layer 6<!-- -->)<!-- -->. You can customize which checkers get used in which contexts in <code>context.json</code>.</li></ol><p>The test harness takes all <code>contexts</code>, <code>graphs</code>, <code>tests</code>, and <code>checkers</code> and generates a test flow for every combination of them, unless you explicitly set constraints on what combinations are allowed. The test flows are then executed, optionally in parallel, and results are collected and summarized.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="contexts"><strong>Contexts</strong><a class="hash-link" href="#contexts" title="Direct link to heading">â€‹</a></h3><p>Contexts are defined in <code>contexts.json</code>. The file should be pretty self-explanatory. Most likely you do not need to edit the file unless you are adding tests for a new command-line argument.</p><p>Note that some contexts have <code>disabled: true</code>. These contexts are not executed by default when tests are run by a CI system. You can enable them on the command line for local testing, as shown below.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tests"><strong>Tests</strong><a class="hash-link" href="#tests" title="Direct link to heading">â€‹</a></h3><p>Take a look at <code>tests/basic_artifact.py</code>. This test verifies that artifacts defined in the first step are available in all steps downstream. You can use this simple test as a template for new tests.</p><p>Your test class should derive from <code>MetaflowTest</code>. The class variable <code>PRIORITY</code> denotes how fundamental the exercised functionality is to Metaflow. The tests are executed in the ascending order of priority, to make sure that foundations are solid before proceeding to more sophisticated cases.</p><p>The step functions are decorated with the <code>@steps</code> decorator. Note that in contrast to normal Metaflow flows, these functions can be applied to multiple steps in a graph. A core idea behind this test harness is to decouple graphs from step functions, so various combinations can be tested automatically. Hence, you need to provide step functions that can be applied to various step types.</p><p>The <code>@steps</code> decorator takes two arguments. The first argument is an integer that defines the order of precedence between multiple <code>steps</code> functions, in case multiple step function templates match. A typical pattern is to provide a specific function for a specific step type, such as joins and give it a precedence of <code>0</code>. Then another catch-all can be defined with <code>@steps(2, [&#x27;all&#x27;])</code>. As the result, the special function is applied to joins and the catch all function for all other steps.</p><p>The second argument gives a list of <em>qualifiers</em> specifying which types of steps this function can be applied to. There is a set of built-in qualifiers: <code>all</code>, <code>start</code>, <code>end</code>, <code>join</code>, <code>linear</code> which match to the corresponding step types. In addition to these built-in qualifiers, graphs can specify any custom qualifiers.</p><p>By specifying <code>required=True</code> as a keyword argument to <code>@steps</code>, you can require that a certain step function needs to be used in combination with a graph to produce a valid test case. By creating a custom qualifier and setting <code>required=True</code> you can control how tests get matched to graphs.</p><p>In general, it is beneficial to write test cases that do not specify overly restrictive qualifiers and <code>required=True</code>. This way you cast a wide net to catch bugs with many generated test cases. However, if the test is slow to execute and/or does not benefit from a large number of matching graphs, it is a good idea to make it more specific.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="assertions"><strong>Assertions</strong><a class="hash-link" href="#assertions" title="Direct link to heading">â€‹</a></h4><p>The test case is not very useful unless it verifies its results. There are two ways to assert that the test behaves as expected.</p><p>You can use a function <code>assert_equals(expected, got)</code> inside step functions to confirm that data inside the step functions is valid. Secondly, you can define a method <code>check_results(self, flow, checker)</code> in your test class, which verifies the stored results after the flow has been executed successfully.</p><p>Use</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">checker.assert_artifact(step_name, artifact_name, expected_value)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>to assert that steps contain the expected data artifacts.</p><p>Take a look at existing test cases in the <code>tests</code> directory to get an idea how this works in practice.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="graphs"><strong>Graphs</strong><a class="hash-link" href="#graphs" title="Direct link to heading">â€‹</a></h3><p>Graphs are simple JSON representations of directed graphs. They list every step in a graph and transitions between them. Every step can have an optional list of custom qualifiers, as described above.</p><p>You can take a look at the existing graphs in the <code>graphs</code> directory to get an idea of the syntax.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="checkers"><strong>Checkers</strong><a class="hash-link" href="#checkers" title="Direct link to heading">â€‹</a></h3><p>Currently the test harness exercises two types of user interfaces: The command line interface, defined in <code>cli_check.py</code>, and the Python API, defined in <code>mli_check.py</code>.</p><p>Currently you can use these checkers to assert values of data artifacts or log output. If you want to add test for new type of functionality in the CLI and/or the Python API, you should add a new method in the <code>MetaflowCheck</code> base class and corresponding implementations in <code>mli_check.py</code> and <code>cli_check.py</code>. If certain functionality is only available in one of the interfaces, you can provide a stub implementation returning <code>True</code> in the other checker class.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="usage">Usage<a class="hash-link" href="#usage" title="Direct link to heading">â€‹</a></h2><p>The test harness is executed by running <code>run_tests.py</code>. By default, it executes all valid combinations of contexts, tests, graphs, and checkers. This mode is suitable for automated tests run by a CI system.</p><p>When testing locally, it is recommended to run the test suite as follows:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cd metaflow/test/core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PYTHONPATH=`pwd`/../../ python run_tests.py --debug --contexts dev-local</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This uses only the <code>dev_local</code> context, which does not depend on any over-the-network communication like <code>--metadata=service</code> or <code>--datastore=s3</code>. The <code>--debug</code> flag makes the harness fail fast when the first test case fails. The default mode is to run all test cases and summarize all failures in the end.</p><p>You can run a single test case as follows:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cd metaflow/test/core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PYTHONPATH=`pwd`/../../ python run_tests.py --debug --contexts dev-local --graphs single-linear-step --tests BasicArtifactTest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This chooses a single context, a single graph, and a single test. If you are developing a new test, this is the fastest way to test the test.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="coverage-report">Coverage report<a class="hash-link" href="#coverage-report" title="Direct link to heading">â€‹</a></h3><p>The test harness uses the <code>coverage</code> package in Python to produce a test coverage report. By default, you can find a comprehensive test coverage report in the <code>coverage</code> directory after the test harness has finished.</p><p>After you have developed a new feature in Metaflow, use the line-by-line coverage report to confirm that all lines related the new feature are touched by the tests.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.dev/obgibson/metaflow-docs/blob/master/docs/python/internals-of-metaflow/testing-philosophy.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/python/internals-of-metaflow/technical-overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Technical Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#metaflow-test-suite" class="table-of-contents__link toc-highlight">Metaflow Test Suite</a></li><li><a href="#specifications" class="table-of-contents__link toc-highlight">Specifications</a><ul><li><a href="#contexts" class="table-of-contents__link toc-highlight"><strong>Contexts</strong></a></li><li><a href="#tests" class="table-of-contents__link toc-highlight"><strong>Tests</strong></a></li><li><a href="#graphs" class="table-of-contents__link toc-highlight"><strong>Graphs</strong></a></li><li><a href="#checkers" class="table-of-contents__link toc-highlight"><strong>Checkers</strong></a></li></ul></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a><ul><li><a href="#coverage-report" class="table-of-contents__link toc-highlight">Coverage report</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.d33b45f4.js"></script>
<script src="/assets/js/main.18225576.js"></script>
</body>
</html>