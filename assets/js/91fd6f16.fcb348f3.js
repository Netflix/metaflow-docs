"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[2840],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=o.createContext({}),s=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=s(e.components);return o.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,p=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=s(n),u=a,f=c["".concat(p,".").concat(u)]||c[u]||m[u]||r;return n?o.createElement(f,l(l({ref:t},d),{},{components:n})):o.createElement(f,l({ref:t},d))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=c;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var s=2;s<r;s++)l[s]=n[s];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4908:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>i,toc:()=>s});var o=n(7462),a=(n(7294),n(3905));const r={},l="Deploying Flows Programmatically",i={unversionedId:"metaflow/managing-flows/deployer",id:"metaflow/managing-flows/deployer",title:"Deploying Flows Programmatically",description:"Besides running flows via an API, you can deploy flows to",source:"@site/docs/metaflow/managing-flows/deployer.md",sourceDirName:"metaflow/managing-flows",slug:"/metaflow/managing-flows/deployer",permalink:"/metaflow/managing-flows/deployer",draft:!1,editUrl:"https://github.dev/Netflix/metaflow-docs/blob/master/docs/metaflow/managing-flows/deployer.md",tags:[],version:"current",frontMatter:{},sidebar:"python",previous:{title:"Running Flows Programmatically",permalink:"/metaflow/managing-flows/runner"},next:{title:"Debugging Flows",permalink:"/metaflow/debugging"}},p={},s=[{value:"Deploying to production with the <code>Deployer</code> API",id:"deploying-to-production-with-the-deployer-api",level:2},{value:"Triggering a flow explicitly",id:"triggering-a-flow-explicitly",level:2},{value:"Terminating a triggered run",id:"terminating-a-triggered-run",level:3},{value:"Accessing Previously Deployed Flows",id:"accessing-previously-deployed-flows",level:2},{value:"Listing deployed flows",id:"listing-deployed-flows",level:2},{value:"Example: Cleaning up old deployments",id:"example-cleaning-up-old-deployments",level:3},{value:"Orchestrator-specific methods",id:"orchestrator-specific-methods",level:2}],d={toc:s};function m(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,o.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"deploying-flows-programmatically"},"Deploying Flows Programmatically"),(0,a.kt)("p",null,"Besides running flows via an API, you can deploy flows to\n",(0,a.kt)("a",{parentName:"p",href:"/production/scheduling-metaflow-flows/introduction"},"one of the production orchestrators supported by Metaflow"),"\nprogrammatically. For instance, you can use this feature to create a deployment script running\nas ",(0,a.kt)("a",{parentName:"p",href:"https://outerbounds.com/blog/continuous-delivery-of-ml-ai/"},"a part of your CI/CD system"),",\ne.g. on GitHub Actions, to deploy a flow to production automatically after a pull request\nhas been approved."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"For a practical example of ",(0,a.kt)("inlineCode",{parentName:"p"},"Deployer")," in action, see\n",(0,a.kt)("a",{parentName:"p",href:"/metaflow/configuring-flows/config-driven-experimentation#sweep-orchestrating-and-observing-experiments-at-scale"},"the ",(0,a.kt)("inlineCode",{parentName:"a"},"sweep")," example in Config-Driven\nExperimentation"),".")),(0,a.kt)("h2",{id:"deploying-to-production-with-the-deployer-api"},"Deploying to production with the ",(0,a.kt)("inlineCode",{parentName:"h2"},"Deployer")," API"),(0,a.kt)("p",null,"Deployments are handled through ",(0,a.kt)("a",{parentName:"p",href:"/api/deployer"},"the ",(0,a.kt)("inlineCode",{parentName:"a"},"Deployer")," API")," which follows closely the\ncommand line interface used to push flows to production orchestrators like\n",(0,a.kt)("a",{parentName:"p",href:"/production/scheduling-metaflow-flows/scheduling-with-argo-workflows"},"Argo Workflows")," and\n",(0,a.kt)("a",{parentName:"p",href:"/production/scheduling-metaflow-flows/scheduling-with-aws-step-functions"},"Step Functions"),"."),(0,a.kt)("p",null,"This diagram outlines the deployment process and the objects involved:"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(2910).Z,width:"1497",height:"500"})),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Instantiate a ",(0,a.kt)("inlineCode",{parentName:"li"},"Deployer")," class pointing at the flow file you want to deploy:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"from metaflow import Deployer\ndeployer = Deployer('helloflow.py')\n")),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"Choose an orchestrator - here Argo Workflows - and call ",(0,a.kt)("inlineCode",{parentName:"li"},"create()")," to deploy the flow")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"deployed_flow = deployer.argo_workflows().create()\n")),(0,a.kt)("p",null,"The flow is now scheduled for execution! If you had annotated the flow\nwith ",(0,a.kt)("a",{parentName:"p",href:"/api/flow-decorators/schedule"},"a ",(0,a.kt)("inlineCode",{parentName:"a"},"@schedule")," decorator"),", it would\nrun automatically at the desired time.\nHad you annotated it with ",(0,a.kt)("a",{parentName:"p",href:"/api/flow-decorators/trigger"},(0,a.kt)("inlineCode",{parentName:"a"},"@trigger")),",\nor ",(0,a.kt)("a",{parentName:"p",href:"/api/flow-decorators/trigger_on_finish"},(0,a.kt)("inlineCode",{parentName:"a"},"@trigger_on_finish")),", it would\nrun automatically when the specified event arrives."),(0,a.kt)("h2",{id:"triggering-a-flow-explicitly"},"Triggering a flow explicitly"),(0,a.kt)("p",null,"You can trigger a deployed flow explicitly by calling ",(0,a.kt)("inlineCode",{parentName:"p"},"trigger()")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"triggered_run = deployed_flow.trigger()\n")),(0,a.kt)("p",null,"You can specify any ",(0,a.kt)("a",{parentName:"p",href:"/metaflow/basics#how-to-define-parameters-for-flows"},(0,a.kt)("inlineCode",{parentName:"a"},"Parameters")),"\nin ",(0,a.kt)("inlineCode",{parentName:"p"},"trigger"),", e.g."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"triggered_run = deployed_flow.trigger(alpha=5, algorithm='cubic')\n")),(0,a.kt)("p",null,"Triggering returns a ",(0,a.kt)("inlineCode",{parentName:"p"},"TriggeredRun")," object, representing a run that is\nabout to get scheduled by the orchestrator. Only when the ",(0,a.kt)("inlineCode",{parentName:"p"},"start"),"\nstep starts executing, a corresponding ",(0,a.kt)("a",{parentName:"p",href:"/metaflow/client"},(0,a.kt)("inlineCode",{parentName:"a"},"Run")," object"),"\nbecomes accessible. This may take a while, for instance, if a new\ncloud instance needs to start to execute the task:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"# wait for the run object to be available, timeout None means wait forever\nrun_obj = triggered_run.wait_for_run(timeout=None)\nprint('Run started', run_obj)\n")),(0,a.kt)("h3",{id:"terminating-a-triggered-run"},"Terminating a triggered run"),(0,a.kt)("p",null,"You may terminate a triggered run at any time by calling"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"triggered_run.terminate()\n")),(0,a.kt)("h2",{id:"accessing-previously-deployed-flows"},"Accessing Previously Deployed Flows"),(0,a.kt)("p",null,"You can retrieve an existing ",(0,a.kt)("inlineCode",{parentName:"p"},"deployed_flow")," object using the\n",(0,a.kt)("inlineCode",{parentName:"p"},"from_deployment")," method instead of creating a new deployment. This allows\nyou to work with flows that were previously deployed without having to call\ncreate() again."),(0,a.kt)("p",null,"Once you have the deployed_flow object, you can use its trigger() method to\ncreate a ",(0,a.kt)("inlineCode",{parentName:"p"},"triggered_run")," object and execute the flow. This approach is\nparticularly useful when you need to reference and run existing deployments\nrather than creating fresh ones."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"from metaflow import Deployer\n\ndeployer = Deployer('helloflow.py')\ndeployed_flow = deployer.argo_workflows().create()\n\n# save this for later use...\nidentifier = deployed_flow.name\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"from metaflow import DeployedFlow\n\n# use the identifier saved above..\ndeployed_flow = DeployedFlow.from_deployment(identifier=identifier)\ntriggered_run = deployed_flow.trigger()\n")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"from_deployment")," method is only available for argo-workflows at the moment.")),(0,a.kt)("h2",{id:"listing-deployed-flows"},"Listing deployed flows"),(0,a.kt)("p",null,"You can list all deployed flows using the ",(0,a.kt)("inlineCode",{parentName:"p"},"list_deployed_flows")," class method. This is useful for discovering existing deployments, performing cleanup operations, etc."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},'from metaflow import DeployedFlow\n\n# List all deployed flows\nfor df in DeployedFlow.list_deployed_flows():\n    print(f"Found deployment: {df.name}")\n')),(0,a.kt)("p",null,"You can also filter by flow name to find all deployments of a specific flow by passing in the ",(0,a.kt)("inlineCode",{parentName:"p"},"flow_name")," parameter."),(0,a.kt)("h3",{id:"example-cleaning-up-old-deployments"},"Example: Cleaning up old deployments"),(0,a.kt)("p",null,"A common use case is to clean up deployments that haven't been used recently. Here's an example that deletes templates that haven't run in the last 90 days:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},'from datetime import datetime, timedelta\nfrom metaflow import Flow, DeployedFlow, namespace\n\n# Delete templates that haven\'t run in the last 90 days\ncutoff_date = datetime.now() - timedelta(days=90)\n\nfor df in DeployedFlow.list_deployed_flows():\n    try:\n        namespace(None)\n        argo_runs = Flow(df.flow_name).runs("runtime:argo-workflows")\n        latest_run = next(argo_runs, None)\n\n        if latest_run and latest_run.created_at >= cutoff_date:\n            print(f"Keeping recent template: {df.name} (last run: {latest_run.created_at})")\n        else:\n            reason = "no Argo runs" if not latest_run else f"last run: {latest_run.created_at}"\n            print(f"Deleting old template: {df.name} ({reason})")\n            df.delete()\n\n    except Exception as e:\n        print(f"Error processing {df.name}: {e}")\n')),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"list_deployed_flows")," method is only available for argo-workflows at the moment.")),(0,a.kt)("h2",{id:"orchestrator-specific-methods"},"Orchestrator-specific methods"),(0,a.kt)("p",null,"Besides the common methods highlighted above, each orchestrator exposes\nadditional methods for managing deployments and triggered runs. For details,\nsee ",(0,a.kt)("a",{parentName:"p",href:"/api/deployer"},"the API documentation for ",(0,a.kt)("inlineCode",{parentName:"a"},"Deployer")),"."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Currently, ",(0,a.kt)("inlineCode",{parentName:"p"},"Deployer")," doesn't support deployments to Apache Airflow, as Airflow\ndoesn't expose an API for deployments. Instead, you should\n",(0,a.kt)("a",{parentName:"p",href:"/production/scheduling-metaflow-flows/scheduling-with-airflow#pushing-a-flow-to-production"},"copy the resulting Airflow dag"),"\nmanually to your Airflow server.")))}m.isMDXComponent=!0},2910:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/deployer-flow-7936d81719e7b5eec3d34d58ec8f841b.png"}}]);