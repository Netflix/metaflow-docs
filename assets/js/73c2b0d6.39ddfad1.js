"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[6897],{7150:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>w,frontMatter:()=>i,metadata:()=>p,toc:()=>u});var a=n(7462),o=(n(7294),n(3905)),l=n(2004);const i={},r="Scheduling Metaflow Flows with Kubeflow",p={unversionedId:"production/scheduling-metaflow-flows/scheduling-with-kubeflow",id:"production/scheduling-metaflow-flows/scheduling-with-kubeflow",title:"Scheduling Metaflow Flows with Kubeflow",description:"The Kubeflow integration is new and currently released as a Metaflow extension",source:"@site/docs/production/scheduling-metaflow-flows/scheduling-with-kubeflow.md",sourceDirName:"production/scheduling-metaflow-flows",slug:"/production/scheduling-metaflow-flows/scheduling-with-kubeflow",permalink:"/production/scheduling-metaflow-flows/scheduling-with-kubeflow",draft:!1,editUrl:"https://github.dev/Netflix/metaflow-docs/blob/master/docs/production/scheduling-metaflow-flows/scheduling-with-kubeflow.md",tags:[],version:"current",frontMatter:{},sidebar:"python",previous:{title:"Scheduling Metaflow Flows with Apache Airflow",permalink:"/production/scheduling-metaflow-flows/scheduling-with-airflow"},next:{title:"Coordinating Larger Metaflow Projects",permalink:"/production/coordinating-larger-metaflow-projects"}},s={},u=[{value:"Why use Metaflow with Kubeflow",id:"why-use-metaflow-with-kubeflow",level:3},{value:"Setting up the Kubeflow-Metaflow integration",id:"setting-up-the-kubeflow-metaflow-integration",level:2},{value:"Pushing a flow to Kubeflow Pipelines",id:"pushing-a-flow-to-kubeflow-pipelines",level:2},{value:"Triggering a Kubeflow run",id:"triggering-a-kubeflow-run",level:2},{value:"Inspecting the results of a Kubeflow run",id:"inspecting-the-results-of-a-kubeflow-run",level:2}],f={toc:u};function w(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},f,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"scheduling-metaflow-flows-with-kubeflow"},"Scheduling Metaflow Flows with Kubeflow"),(0,o.kt)("admonition",{title:"Note",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"The Kubeflow integration is new and currently released as a Metaflow extension\nwhich you need to install separately as instructed below. The feature set is\nstill evolving and hence subject to change. Reach out to us on ",(0,o.kt)("a",{parentName:"p",href:"http://slack.outerbounds.co"},"Metaflow Slack")," if you have questions about the integration!")),(0,o.kt)("p",null,"Metaflow\u2019s Kubeflow integration lets you develop workflows using Metaflow\u2019s full, developer-friendly feature set, and then deploy those flows to your existing Kubeflow infrastructure, where they run seamlessly alongside your current Kubeflow pipelines."),(0,o.kt)("p",null,"The deployed pipelines are ",(0,o.kt)("strong",{parentName:"p"},"both valid Metaflow flows and Kubeflow pipelines"),",\nallowing you to observe them in real time in the Kubeflow UI and in the Metaflow UI,\nand to access results through Metaflow\u2019s ",(0,o.kt)("a",{parentName:"p",href:"/metaflow/client"},"Client API")," as usual."),(0,o.kt)("p",null,"You can see this in action in this short screencast (no sound):"),(0,o.kt)(l.Z,{controls:!0,url:"https://youtu.be/ALg0A9SzRG8",mdxType:"ReactPlayer"}),(0,o.kt)("br",null),(0,o.kt)("h3",{id:"why-use-metaflow-with-kubeflow"},"Why use Metaflow with Kubeflow"),(0,o.kt)("p",null,"The video highlights the main benefits of the integration:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Metaflow provides ",(0,o.kt)("a",{parentName:"p",href:"https://netflixtechblog.com/supercharging-the-ml-and-ai-development-experience-at-netflix-b2d5b95c63eb"},(0,o.kt)("strong",{parentName:"a"},"a top-notch developer\nexperience")),",\nsparing the developer from Kubernetes-specific technical details.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"You can ",(0,o.kt)("a",{parentName:"p",href:"/scaling/introduction"},"test flows locally at arbitrary scale"),"\nusing ",(0,o.kt)("strong",{parentName:"p"},"the same Kubernetes infrastructure")," that you use with Kubeflow.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Most Metaflow features, such as\n",(0,o.kt)("a",{parentName:"p",href:"/metaflow/debugging#how-to-use-the-resume-command"},"resuming"),",\n",(0,o.kt)("a",{parentName:"p",href:"/metaflow/visualizing-results"},"observability with cards"),",\n",(0,o.kt)("a",{parentName:"p",href:"/scaling/dependencies"},"dependency management"),",\n",(0,o.kt)("a",{parentName:"p",href:"/metaflow/configuring-flows/introduction"},"configuration management"),",\n",(0,o.kt)("a",{parentName:"p",href:"/scaling/tagging"},"namespaces"),",\n",(0,o.kt)("a",{parentName:"p",href:"/metaflow/client"},"artifacts and Client API"),",\nwork out of the box, ",(0,o.kt)("strong",{parentName:"p"},"greatly enhancing the functionality available\nin Kubeflow Pipelines"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Deploy to Kubeflow Pipelines with a single command"),", no changes\nin the Metaflow code required."))),(0,o.kt)("p",null,"Note that Kubeflow Pipelines is built on top of Argo Workflows, so its scalability and\nhigh-availability characteristics closely mirror those of Metaflow\u2019s native\n",(0,o.kt)("a",{parentName:"p",href:"/production/scheduling-metaflow-flows/scheduling-with-argo-workflows"},"Argo Workflows integration"),", with potential additional overhead\nintroduced by the Kubeflow components."),(0,o.kt)("h2",{id:"setting-up-the-kubeflow-metaflow-integration"},"Setting up the Kubeflow-Metaflow integration"),(0,o.kt)("p",null,"Currently, the integration is provided as a Metaflow Extension which you can\ninstall as follows"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"pip install metaflow-kubeflow\n")),(0,o.kt)("p",null,"Note that you have to install the extension only on the laptop, server, or\nCI/CD worker where you deploy workflows. It doesn't need to be present on\ncontainers executing tasks."),(0,o.kt)("admonition",{title:"Note",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"In order to be able to deploy to Kubeflow, you need to be able to connect to\nKubeflow. In case you don't have connectivity already set up, ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/outerbounds/metaflow-kubeflow"},"see this README\nfor suggestions"),".")),(0,o.kt)("p",null,"You can specify the Kubeflow endpoint address every time you deploy, or you can\nadd it in your Metaflow config (typically at ",(0,o.kt)("inlineCode",{parentName:"p"},"~/.metaflowconfig/config.json"),"):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},' "METAFLOW_KUBEFLOW_PIPELINES_URL": "http://my-kubeflow",\n')),(0,o.kt)("p",null,"Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"http://my-kubeflow")," with the actual address."),(0,o.kt)("h2",{id:"pushing-a-flow-to-kubeflow-pipelines"},"Pushing a flow to Kubeflow Pipelines"),(0,o.kt)("p",null,"Let's use ",(0,o.kt)("a",{parentName:"p",href:"../../metaflow/basics#how-to-define-parameters-for-flows"},"the flow from the section about\nparameters")," as an example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"from metaflow import FlowSpec, Parameter, step\n\nclass ParameterFlow(FlowSpec):\n    alpha = Parameter('alpha',\n                      help='Learning rate',\n                      default=0.01)\n\n    @step\n    def start(self):\n        print('alpha is %f' % self.alpha)\n        self.next(self.end)\n\n    @step\n    def end(self):\n        print('alpha is still %f' % self.alpha)\n\nif __name__ == '__main__':\n    ParameterFlow()\n")),(0,o.kt)("p",null,"Save the flow in a file ",(0,o.kt)("inlineCode",{parentName:"p"},"parameter_flow.py"),". To deploy a version to Kubeflow Pipelines,\ntype"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python parameter_flow.py kubeflow-pipelines create\n")),(0,o.kt)("p",null,"Or, if you haven't specified ",(0,o.kt)("inlineCode",{parentName:"p"},"METAFLOW_KUBEFLOW_PIPELINES_URL")," in your Metaflow\nconfig, specify a Kubeflow URL on the command line:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python parameter_flow.py kubeflow-pipelines create --url http://my-kubeflow\n")),(0,o.kt)("p",null,"This command will ",(0,o.kt)("a",{parentName:"p",href:"scaling/dependencies"},"package the flow and its execution\nenvironment"),", convert it to a Kubeflow Pipeline, and deploy\nit to the specified server."),(0,o.kt)("p",null,"The pipeline name matches the flow name. Each deployment created with\n",(0,o.kt)("inlineCode",{parentName:"p"},"kubeflow-pipelines create")," produces a new pipeline version, which by default is\nnamed using the current timestamp, unless you explicitly override the version name\nwith the ",(0,o.kt)("inlineCode",{parentName:"p"},"--version-name")," option."),(0,o.kt)("admonition",{title:"Note",type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"/metaflow/basics#conditionals"},"Conditional and recursive steps"),"\nintroduced in Metaflow 2.18, are not yet supported\non Kubeflow deployments. Contact ",(0,o.kt)("a",{parentName:"p",href:"http://slack.outerbounds.co"},"the Metaflow Slack")," if\nyou have a use case for this feature.")),(0,o.kt)("h2",{id:"triggering-a-kubeflow-run"},"Triggering a Kubeflow run"),(0,o.kt)("p",null,"You can trigger a deployed flow to run on Kubeflow pipelines with the ",(0,o.kt)("inlineCode",{parentName:"p"},"trigger"),"\ncommand:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python parameter_flow.py kubeflow-pipelines trigger\n")),(0,o.kt)("p",null,"Specify ",(0,o.kt)("inlineCode",{parentName:"p"},"--url")," as above, unless the URL is specified in the config."),(0,o.kt)("p",null,"You can pass parameters to a run as usual:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python parameter_flow.py kubeflow-pipelines trigger --alpha 0.5\n")),(0,o.kt)("p",null,"You can also trigger a run as a specific ",(0,o.kt)("a",{parentName:"p",href:"https://www.kubeflow.org/docs/components/pipelines/concepts/experiment/"},"Kubeflow\nExperiment"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python parameter_flow.py kubeflow-pipelines trigger --alpha 0.5 --experiment new_model\n")),(0,o.kt)("p",null,"By default, the latest version of the flow is triggered. You can trigger an\nolder version by specifying ",(0,o.kt)("inlineCode",{parentName:"p"},"--version-name"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python parameter_flow.py kubeflow-pipelines trigger --alpha 0.5 --version-name 20251216021104161376\n")),(0,o.kt)("admonition",{title:"Note",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Currently only manual triggering with ",(0,o.kt)("inlineCode",{parentName:"p"},"trigger")," is supported. If you are interested\nin ",(0,o.kt)("a",{parentName:"p",href:"/api/flow-decorators/schedule"},"scheduled")," or\n",(0,o.kt)("a",{parentName:"p",href:"/production/event-triggering"},"event-triggered runs"),",\nreach out to us on ",(0,o.kt)("a",{parentName:"p",href:"http://slack.outerbounds.co"},"Metaflow Slack"))),(0,o.kt)("h2",{id:"inspecting-the-results-of-a-kubeflow-run"},"Inspecting the results of a Kubeflow run"),(0,o.kt)("p",null,"Every Kubeflow run is a valid Metaflow run which you can inspect using the Metaflow UI\nand ",(0,o.kt)("a",{parentName:"p",href:"/metaflow/client"},"the Client API")," as usual."),(0,o.kt)("p",null,"Note that ",(0,o.kt)("a",{parentName:"p",href:"scaling/tagging#production-namespaces"},"Metaflow's namespaces")," apply on\nKubeflow too, so to access Kubeflow results, you can switch to ",(0,o.kt)("a",{parentName:"p",href:"/scaling/tagging#global-namespace"},"the global\nnamespace"),", like here:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"from metaflow import Flow, namespace\nnamespace(None)\nrun = Flow('ParameterFlow')['kfp-066dcf8a-61dd-4f61-b652-e161124bc3b3']\nprint(f'Alpha is {run.data.alpha}')\n")),(0,o.kt)("admonition",{title:"Run IDs match",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Metaflow Run IDs corresponding to Kubeflows runs match their Kubeflow\nrun IDs, prefixed with ",(0,o.kt)("inlineCode",{parentName:"p"},"kfp-")," (e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"kfp-066dcf8a-61dd-4f61-b652-e161124bc3b3"),") so you can easily identify and track lineage of runs between Metaflow and Kubeflow.")))}w.isMDXComponent=!0}}]);