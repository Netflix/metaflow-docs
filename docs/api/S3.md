# S3 - Accessing data in S3 quickly

The `S3` client is a wrapper over the standard AWS Python library, `boto`. It contains enhancements that are relevant for data-intensive applications:

 - Supports accessing large amounts of data quickly through parallel operations (functions with the `_many` suffix). You can download up to 20Gbps on a large EC2 instance.
 - Improved error handling.
 - Supports versioned data through `S3(run=self)` and `S3(run=Run)`.
 - User-friendly API with minimal boilerplate.
 - Convenient API for advanced featured such as range requests (downloading partial files) and object headers.
 
For instructions how to use the class, see [Loading and Storing Data](/scaling/data).

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! Instead, edit the notebook w/the location & name as this file. -->

## The `S3` client


<DocSection type="class" name="S3" module="metaflow" show_import="True" heading_level="3" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L392">
<SigArgSection>
<SigArg name="tmproot='.', bucket=None, prefix=None, run=None, s3root=None" />
</SigArgSection>
<Description summary="The Metaflow S3 client." extended_summary="This object manages the connection to S3 and a temporary directory that is used\nto download objects. Note that in most cases when the data fits in memory, no local\ndisk IO is needed as operations are cached by the operating system, which makes\noperations fast as long as there is enough memory available.\n\nThe easiest way is to use this object as a context manager:\n```\nwith S3() as s3:\n    data = [obj.blob for obj in s3.get_many(urls)]\nprint(data)\n```\nThe context manager takes care of creating and deleting a temporary directory\nautomatically. Without a context manager, you must call `.close()` to delete\nthe directory explicitly:\n```\ns3 = S3()\ndata = [obj.blob for obj in s3.get_many(urls)]\ns3.close()\n```\nYou can customize the location of the temporary directory with `tmproot`. It\ndefaults to the current working directory.\n\nTo make it easier to deal with object locations, the client can be initialized\nwith an S3 path prefix. There are three ways to handle locations:\n\n1. Use a `metaflow.Run` object or `self`, e.g. `S3(run=self)` which\n   initializes the prefix with the global `DATATOOLS_S3ROOT` path, combined\n   with the current run ID. This mode makes it easy to version data based\n   on the run ID consistently. You can use the `bucket` and `prefix` to\n   override parts of `DATATOOLS_S3ROOT`.\n\n2. Specify an S3 prefix explicitly with `s3root`,\n   e.g. `S3(s3root='s3://mybucket/some/path')`.\n\n3. Specify nothing, i.e. `S3()`, in which case all operations require\n   a full S3 url prefixed with `s3://`." />
<ParamSection name="Parameters">
	<Parameter name="tmproot" type="str" desc="Where to store the temporary directory (default: '.')." />
	<Parameter name="bucket" type="str" desc="Override the bucket from `DATATOOLS_S3ROOT` when `run` is specified." />
	<Parameter name="prefix" type="str" desc="Override the path from `DATATOOLS_S3ROOT` when `run` is specified." />
	<Parameter name="run" type="FlowSpec or Run" desc="Derive path prefix from the current or a past run ID, e.g. S3(run=self)." />
	<Parameter name="s3root" type="str" desc="If `run` is not specified, use this as the S3 prefix." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.close" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L509">
<SigArgSection>
<SigArg name="self" />
</SigArgSection>
<Description summary="Delete all temporary files downloaded in this context." />

</DocSection>


## Downloading data


<DocSection type="method" name="S3.get" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L780">
<SigArgSection>
<SigArg name="self" /><SigArg name="key" default="None" /><SigArg name="return_missing" default="False" /><SigArg name="return_info" default="True" />
</SigArgSection>
<Description summary="Get a single object from S3." />
<ParamSection name="Parameters">
	<Parameter name="key" type="str or `S3GetObject`" desc="Object to download. It can be an S3 url, a path suffix, or\nan `S3GetObject` that defines a range of data to download." />
	<Parameter name="return_missing" type="bool" desc="If set to True, do not raise an exception for a missing key but\nreturn it as an `S3Object` with `.exists == False` (default: False)." />
	<Parameter name="return_info" type="bool" desc="If set to True, fetch the content-type and user metadata associated\nwith the object at no extra cost, included for symmetry with `get_many`\n(default: True)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="`S3Object`" desc="An S3Object corresponding to the object requested." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.get_many" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L868">
<SigArgSection>
<SigArg name="self" /><SigArg name="keys" /><SigArg name="return_missing" default="False" /><SigArg name="return_info" default="True" />
</SigArgSection>
<Description summary="Get many objects from S3 in parallel." />
<ParamSection name="Parameters">
	<Parameter name="keys" type="List[str or `S3GetObject`]" desc="Objects to download. Each object can be an S3 url, a path suffix, or\nan `S3GetObject` that defines a range of data to download." />
	<Parameter name="return_missing" type="bool" desc="If set to True, do not raise an exception for a missing key but\nreturn it as an `S3Object` with `.exists == False` (default: False)." />
	<Parameter name="return_info" type="bool" desc="If set to True, fetch the content-type and user metadata associated\nwith the object at no extra cost, included for symmetry with `get_many`\n(default: True)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[`S3Object`]" desc="S3Objects corresponding to the objects requested." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.get_recursive" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L937">
<SigArgSection>
<SigArg name="self" /><SigArg name="keys" /><SigArg name="return_info" default="False" />
</SigArgSection>
<Description summary="Get many objects from S3 recursively in parallel." />
<ParamSection name="Parameters">
	<Parameter name="keys" type="List[str]" desc="Prefixes to download recursively. Each prefix can be an S3 url or a path suffix\nwhich define the root prefix under which all objects are downloaded." />
	<Parameter name="return_info" type="bool" desc="If set to True, fetch the content-type and user metadata associated\nwith the object (default: False)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[`S3Object`]" desc="S3Objects stored under the given prefixes." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.get_all" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L989">
<SigArgSection>
<SigArg name="self" /><SigArg name="return_info" default="False" />
</SigArgSection>
<Description summary="Get all objects under the prefix set in the `S3` constructor." extended_summary="This method requires that the `S3` object is initialized either with `run` or\n`s3root`." />
<ParamSection name="Parameters">
	<Parameter name="return_info" type="bool" desc="If set to True, fetch the content-type and user metadata associated\nwith the object (default: False)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[`S3Object`]" desc="S3Objects stored under the main prefix." />
</ParamSection>
</DocSection>


## Listing objects


<DocSection type="method" name="S3.list_paths" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L574">
<SigArgSection>
<SigArg name="self" /><SigArg name="keys" default="None" />
</SigArgSection>
<Description summary="List the next level of paths in S3." extended_summary="If multiple keys are specified, listings are done in parallel. The returned\nS3Objects have `.exists == False` if the path refers to a prefix, not an\nexisting S3 object.\n\nFor instance, if the directory hierarchy is\n```\na/0.txt\na/b/1.txt\na/c/2.txt\na/d/e/3.txt\nf/4.txt\n```\nThe `list_paths(['a', 'f'])` call returns\n```\na/0.txt (exists == True)\na/b/ (exists == False)\na/c/ (exists == False)\na/d/ (exists == False)\nf/4.txt (exists == True)\n```" />
<ParamSection name="Parameters">
	<Parameter name="keys" type="List(str)" desc="List of paths." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[`S3Object`]" desc="S3Objects under the given paths, including prefixes (directories) that\ndo not corresponding to leaf objects." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.list_recursive" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L624">
<SigArgSection>
<SigArg name="self" /><SigArg name="keys" default="None" />
</SigArgSection>
<Description summary="List all objects recursives under the given prefixes." extended_summary="If multiple keys are specified, listings are done in parallel. All objects\nreturned have `.exists == True` as this call always returns leaf objects.\n\nFor instance, if the directory hierarchy is\n```\na/0.txt\na/b/1.txt\na/c/2.txt\na/d/e/3.txt\nf/4.txt\n```\nThe `list_paths(['a', 'f'])` call returns\n```\na/0.txt (exists == True)\na/b/1.txt (exists == True)\na/c/2.txt (exists == True)\na/d/e/3.txt (exists == True)\nf/4.txt (exists == True)\n```" />
<ParamSection name="Parameters">
	<Parameter name="keys" type="List(str)" desc="List of paths." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[`S3Object`]" desc="S3Objects under the given paths." />
</ParamSection>
</DocSection>


## Uploading data


<DocSection type="method" name="S3.put" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L1015">
<SigArgSection>
<SigArg name="self" /><SigArg name="key" /><SigArg name="obj" /><SigArg name="overwrite" default="True" /><SigArg name="content_type" default="None" /><SigArg name="metadata" default="None" />
</SigArgSection>
<Description summary="Upload a single object to S3." />
<ParamSection name="Parameters">
	<Parameter name="key" type="str or `S3PutObject`" desc="Object path. It can be an S3 url or a path suffix." />
	<Parameter name="obj" type="bytes or str" desc="An object to store in S3. Strings are converted to UTF-8 encoding." />
	<Parameter name="overwrite" type="bool" desc="Overwrite the object if it exists. If set to False, the operation\nsucceeds without uploading anything if the key already exists\n(default: True)." />
	<Parameter name="content_type" type="str" desc="Optional MIME type for the object." />
	<Parameter name="metadata" type="Dict" desc="A JSON-encodable dictionary of additional headers to be stored\nas metadata with the object." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="str" desc="URL of the object stored." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.put_many" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L1097">
<SigArgSection>
<SigArg name="self" /><SigArg name="key_objs" /><SigArg name="overwrite" default="True" />
</SigArgSection>
<Description summary="Upload many objects to S3." extended_summary="Each object to be uploaded can be specified in two ways:\n\n1. As a a `(key, obj)` tuple where `key` is a string specifying\n   the path and `obj` is a string or a bytes object.\n\n2. As a `S3PutObject` which contains additional metadata to be\n   stored with the object." />
<ParamSection name="Parameters">
	<Parameter name="key_objs" type="List[(str, str) or `S3PutObject`]" desc="List of key-object pairs to upload." />
	<Parameter name="overwrite" type="bool" desc="Overwrite the object if it exists. If set to False, the operation\nsucceeds without uploading anything if the key already exists\n(default: True)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[(str, str)]" desc="List of `(key, url)` pairs corresponding to the objects uploaded." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.put_files" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L1166">
<SigArgSection>
<SigArg name="self" /><SigArg name="key_paths" /><SigArg name="overwrite" default="True" />
</SigArgSection>
<Description summary="Upload many local files to S3." extended_summary="Each file to be uploaded can be specified in two ways:\n\n1. As a a `(key, path)` tuple where `key` is a string specifying\n   the S3 path and `path` is the path to a local file.\n\n2. As a `S3PutObject` which contains additional metadata to be\n   stored with the file." />
<ParamSection name="Parameters">
	<Parameter name="key_paths" type="List[(str, str) or `S3PutObject`]" desc="List of files to upload." />
	<Parameter name="overwrite" type="bool" desc="Overwrite the object if it exists. If set to False, the operation\nsucceeds without uploading anything if the key already exists\n(default: True)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[(str, str)]" desc="List of `(key, url)` pairs corresponding to the files uploaded." />
</ParamSection>
</DocSection>


## Querying metadata


<DocSection type="method" name="S3.info" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L670">
<SigArgSection>
<SigArg name="self" /><SigArg name="key" default="None" /><SigArg name="return_missing" default="False" />
</SigArgSection>
<Description summary="Get metadata about a single object in S3." extended_summary="This call makes a single `HEAD` request to S3 which can be\nmuch faster than downloading all data with `get`." />
<ParamSection name="Parameters">
	<Parameter name="key" type="str" desc="Object to query. It can be an S3 url or a path suffix." />
	<Parameter name="return_missing" type="bool" desc="If set to True, do not raise an exception for a missing key but\nreturn it as an `S3Object` with `.exists == False` (default: False)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="`S3Object`" desc="An S3Object corresponding to the object requested. The object\nwill have `.downloaded == False`." />
</ParamSection>
</DocSection>



<DocSection type="method" name="S3.info_many" module="metaflow" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L724">
<SigArgSection>
<SigArg name="self" /><SigArg name="keys" /><SigArg name="return_missing" default="False" />
</SigArgSection>
<Description summary="Get metadata about many objects in S3 in parallel." extended_summary="This call makes a single `HEAD` request to S3 which can be\nmuch faster than downloading all data with `get`." />
<ParamSection name="Parameters">
	<Parameter name="keys" type="List[str]" desc="Objects to query. Each key can be an S3 url or a path suffix." />
	<Parameter name="return_missing" type="bool" desc="If set to True, do not raise an exception for a missing key but\nreturn it as an `S3Object` with `.exists == False` (default: False)." />
</ParamSection>
<ParamSection name="Returns">
	<Parameter type="List[`S3Object`]" desc="A list of `S3Object`s corresponding to the paths requested. The\nobjects will have `.downloaded == False`." />
</ParamSection>
</DocSection>


## Handling results with `S3Object`

Most operations above return `S3Object`s that encapsulate information about S3 paths and objects.

Note that the data itself is not kept in these objects, but is stored in a temporary directory which is accessible through the properties of this object.


<DocSection type="class" name="S3Object" module="metaflow" show_import="False" heading_level="3" link="https://github.com/Netflix/metaflow/tree/master/scaling/datatools/s3.py#L94">
<SigArgSection>
<SigArg name="" />
</SigArgSection>
<Description summary="This object represents a path or an object in S3,\nwith an optional local copy." extended_summary="`S3Object`s are not instantiated directly but they are returned\nby many methods of the `S3` client." />

</DocSection>



<DocSection type="property" name="S3Object.exists" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Does this key correspond to an object in S3?\n" />
<ParamSection name="Returns">
<Parameter type="bool" desc="True if this object points at an existing object (file) in S3." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.downloaded" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Has this object been downloaded?\n\nIf True, the contents can be accessed through `path`, `blob`,\nand `text` properties.\n" />
<ParamSection name="Returns">
<Parameter type="bool" desc="True if the contents of this object have been downloaded." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.url" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="S3 location of the object\n" />
<ParamSection name="Returns">
<Parameter type="str" desc="The S3 location of this object." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.prefix" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Prefix requested that matches this object.\n" />
<ParamSection name="Returns">
<Parameter type="str" desc="Requested prefix" />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.key" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Key corresponds to the key given to the get call that produced\nthis object.\n\nThis may be a full S3 URL or a suffix based on what\nwas requested.\n" />
<ParamSection name="Returns">
<Parameter type="str" desc="Key requested." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.path" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Path to a local temporary file corresponding to the object downloaded.\n\nThis file gets deleted automatically when a S3 scope exits.\nReturns None if this S3Object has not been downloaded.\n" />
<ParamSection name="Returns">
<Parameter type="str" desc="Local path, if the object has been downloaded." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.blob" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Contents of the object as a byte string or None if the\nobject hasn't been downloaded.\n" />
<ParamSection name="Returns">
<Parameter type="bytes" desc="Contents of the object as bytes." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.text" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Contents of the object as a string or None if the\nobject hasn't been downloaded.\n\nThe object is assumed to contain UTF-8 encoded data.\n" />
<ParamSection name="Returns">
<Parameter type="str" desc="Contents of the object as text." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.size" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Size of the object in bytes.\n\nReturns None if the key does not correspond to an object in S3.\n" />
<ParamSection name="Returns">
<Parameter type="int" desc="Size of the object in bytes, if the object exists." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.has_info" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Returns true if this `S3Object` contains the content-type MIME header or\nuser-defined metadata.\n\nIf False, this means that `content_type`, `metadata`, `range_info` and\n`last_modified`will retuern None.\n" />
<ParamSection name="Returns">
<Parameter type="bool" desc="True if additional metadata is available." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.metadata" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Returns a dictionary of user-defined metadata, or None if no metadata\nis defined.\n" />
<ParamSection name="Returns">
<Parameter type="Dict" desc="User-defined metadata." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.content_type" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Returns the content-type of the S3 object or None if it is not defined.\n" />
<ParamSection name="Returns">
<Parameter type="str" desc="Content type or None if the content type is undefined." />
</ParamSection>
</DocSection>



<DocSection type="property" name="S3Object.range_info" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="If the object corresponds to a partially downloaded object, return\ninformation of what was downloaded.\n\nThe returned object has the following fields:\n- `total_size`: Size of the object in S3.\n- `request_offset`: The starting offset.\n- `request_length`: The number of bytes downloaded.\n" />
</DocSection>



<DocSection type="property" name="S3Object.last_modified" module="metaflow.datatools.s3" show_import="False" heading_level="4" link="https://github.com/Netflix/metaflow/tree/master/">

<Description summary="Returns the last modified unix timestamp of the object.\n" />
<ParamSection name="Returns">
<Parameter type="int" desc="Unix timestamp corresponding to the last modified time." />
</ParamSection>
</DocSection>


## Helper Objects

These objects are simple containers that are used to pass information to `get_many`, `put_many`, and `put_files`. You may use your own objects instead of them, as long as they provide the same set of attributes.


<DocSection type="class" name="S3GetObject" module="metaflow.datatools.s3" show_import="True" heading_level="3" link="https://github.com/Netflix/metaflow/tree/master/">
<SigArgSection>
<SigArg name="key" default="None" /><SigArg name="offset" default="None" /><SigArg name="length" default="None" />
</SigArgSection>
<Description summary="Represents a chunk of an S3 object. A range query is performed to download only a subset of data,\n`object[key][offset:offset + length]`, from S3." />
<ParamSection name="Attributes">
	<Parameter name="key" type="str" desc="Key identifying the object. Works the same way as any `key` passed to `get` or `get_many`." />
	<Parameter name="offset" type="int" desc="A byte offset in the file." />
	<Parameter name="length" type="int" desc="The number of bytes to download." />
</ParamSection>
</DocSection>



<DocSection type="class" name="S3PutObject" module="metaflow.datatools.s3" show_import="True" heading_level="3" link="https://github.com/Netflix/metaflow/tree/master/">
<SigArgSection>
<SigArg name="key" default="None" /><SigArg name="value" default="None" /><SigArg name="path" default="None" /><SigArg name="content_type" default="None" /><SigArg name="metadata" default="None" />
</SigArgSection>
<Description summary="Defines an object with metadata to be uploaded with `put_many` or `put_files`." />
<ParamSection name="Attributes">
	<Parameter name="key" type="str" desc="Key identifying the object. Works the same way as `key` passed to `put` or `put_many`." />
	<Parameter name="value" type="str or bytes" desc="Object to upload. Works the same way as `obj` passed `to `put` or `put_many`." />
	<Parameter name="path" type="str" desc="Path to a local file. Works the same way as `path` passed to `put_files`." />
	<Parameter name="content_type" type="str" desc="Optional MIME type for the file." />
	<Parameter name="metadata" type="Dict" desc="A JSON-encodable dictionary of additional headers to be stored\nas metadata with the file." />
</ParamSection>
</DocSection>

