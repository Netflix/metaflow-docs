<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-148913719-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Metaflow Docs" href="/opensearch.xml"><title data-react-helmet="true">Scaling Out and Up | Metaflow Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://docs.metaflow.org/img/Metaflow_Logo_Vertical_FullColor_Ribbon_Dark_RGB.png"><meta data-react-helmet="true" name="twitter:image" content="https://docs.metaflow.org/img/Metaflow_Logo_Vertical_FullColor_Ribbon_Dark_RGB.png"><meta data-react-helmet="true" property="og:url" content="https://docs.metaflow.org/v/r/metaflow/scaling"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Scaling Out and Up | Metaflow Docs"><meta data-react-helmet="true" name="description" content="From a usability point of view, it is hard to beat the convenience of writing and running a straightforward script in the comfort of your favorite IDE and a local terminal. Since one of the core values of Metaflow is usability, we encourage you to start with this easy approach and not worry about scalability until it becomes an issue."><meta data-react-helmet="true" property="og:description" content="From a usability point of view, it is hard to beat the convenience of writing and running a straightforward script in the comfort of your favorite IDE and a local terminal. Since one of the core values of Metaflow is usability, we encourage you to start with this easy approach and not worry about scalability until it becomes an issue."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.metaflow.org/v/r/metaflow/scaling"><link data-react-helmet="true" rel="alternate" href="https://docs.metaflow.org/v/r/metaflow/scaling" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.metaflow.org/v/r/metaflow/scaling" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://5IZ8L9TJQL-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.bf7ddef0.css">
<link rel="preload" href="/assets/js/runtime~main.9f38e140.js" as="script">
<link rel="preload" href="/assets/js/main.871dc34a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="64px"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="64px"></div></a><a class="navbar__item navbar__link" href="/">Python Docs</a><a class="navbar__item navbar__link navbar__link--active" href="/v/r">R Docs</a><a href="https://outerbounds.com/docs/admin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Admin Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v/r">Welcome to Metaflow for R</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/v/r/introduction/why-metaflow">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/v/r/getting-started/install">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/v/r/metaflow-on-aws">Metaflow on AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/v/r/metaflow/basics">Developing with Metaflow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v/r/metaflow/basics">Basics of Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v/r/metaflow/client">Inspecting Flows and Results</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v/r/metaflow/debugging">Debugging with Metaflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/v/r/metaflow/scaling">Scaling Out and Up</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v/r/metaflow/failures">Dealing with Failures</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v/r/metaflow/tagging">Organizing Results</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/v/r/going-to-production-with-metaflow/scheduling-metaflow-flows">Going to Production with Metaflow</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Scaling Out and Up</h1><p>From a usability point of view, it is hard to beat the convenience of writing and running a straightforward script in the comfort of your favorite IDE and a local terminal. Since one of the core values of Metaflow is usability, we encourage you to start with this easy approach and not worry about scalability until it becomes an issue.</p><p>Instead of providing magical abstractions or a new paradigm for scalability, Metaflow provides a set of easy-to-use tools that help you to make your code scalable depending on your specific needs.</p><p>The scalability tools fall into three categories:</p><p><strong>Performance Optimization</strong>: You can improve performance of your code by utilizing off-the-shelf, high-performance libraries such as <a href="https://github.com/dmlc/xgboost" target="_blank" rel="noopener noreferrer">XGboost</a> or <a href="https://tensorflow.org" target="_blank" rel="noopener noreferrer">Tensorflow</a>. Sometimes, it is appropriate to implement a custom algorithm in a high-performance language such as C++ which can be called from your Metaflow steps. Or, as a happy medium between low-performance but productive R and a fast but tedious C++, you may be able to use a compiler such as <a href="http://www.rcpp.org/" target="_blank" rel="noopener noreferrer">Rcpp</a> to speed up your code.</p><p><strong>Scaling Up</strong>: One should not underestimate the horsepower of modern large server type machine. It is sometimes worth considering running on a larger machine prior to trying anything else.</p><p><strong>Scaling Out</strong>: Metaflow also integrates with Batch from AWS allowing you to parallelize your steps over an arbitrarily large number of Batch jobs, giving you access to virtually unlimited amount of computing power.</p><p>It is hard to be prescriptive about which of the three categories is most suitable for your problem. Often, the answer is a combination of the three. In general, start with the approach that is the easiest to implement and keep iterating until the performance is satisfactory.</p><p>This section focuses specifically on using Batch to scale up and out: you can use Batch to request a larger instance to run your step as well as use it to parallelize your steps over multiple instances. This section requires you to have Metaflow working with AWS. See the <a href="/v/r/metaflow-on-aws">AWS section</a> for more information on either setting up Metaflow in your <a href="/v/r/metaflow-on-aws/deploy-to-aws">own AWS environment</a> or using the <a href="/v/r/metaflow-on-aws/metaflow-sandbox">provided sandbox</a>.</p><p>This section presents the tools available in Metaflow for scaling up and out.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="requesting-resources-with-resources-decorator">Requesting resources with <code>resources</code> decorator<a class="hash-link" href="#requesting-resources-with-resources-decorator" title="Direct link to heading">â€‹</a></h2><p>Consider the following example:</p><div class="codeBlockContainer_I0IT language-r theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_BvAR">bigsumflow.R</div><div class="codeBlockContent_wNvx r"><pre tabindex="0" class="prism-code language-r codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">library(metaflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start &lt;- function(self) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  big_matrix &lt;- matrix(rexp(80000*80000), 80000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  self$sum &lt;- sum(big_matrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end &lt;- function(self) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sum is: &quot;, self$sum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metaflow(&quot;BigSumFlowR&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decorator(&quot;resources&quot;, memory=60000, cpu=1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step = &quot;start&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r_function = start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    next_step = &quot;end&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step = &quot;end&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r_function = end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This example creates a huge 80000x80000 random matrix, <code>big_matrix</code>. The matrix requires about 80000^2 <!-- -->*<!-- --> 8 bytes = 48GB of memory.</p><p>If you attempt to run this on your local machine, it is likely that the following will happen:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Evaluation error: vector memory exhausted </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limit reached?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This fails quickly due to a <code>MemoryError</code> on most laptops as we are unable to allocate 48GB of memory.</p><p>The <code>resources</code> decorator suggests resource requirements for a step. The <code>memory</code> argument specifies the amount of RAM in megabytes and <code>cpu</code> the number of CPU cores requested. It does not produce the resources magically, which is why the run above failed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-aws-batch">Using AWS Batch<a class="hash-link" href="#using-aws-batch" title="Direct link to heading">â€‹</a></h2><p>The <code>resources</code> decorator gains all its power in collaboration with Batch execution. Note that for this section, you will need to have Metaflow working in an AWS cloud environment <!-- -->(<!-- -->either having <a href="/v/r/metaflow-on-aws/deploy-to-aws">deployed it yourself</a> or running in the <a href="/v/r/metaflow-on-aws/metaflow-sandbox">Metaflow sandbox</a>)</p><p>With the following command, you instruct Metaflow to run all your steps on AWS Batch:</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript bigsumflow.R run --with batch</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in bigsumflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = TRUE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>The <code>--with batch</code> option instructs Metaflow to run all tasks as separate AWS Batch jobs, instead of using a local process for each task. It has the same effect as adding <code>@batch</code> decorator to all steps in the code.</p><p>Note that in this case the <code>resources</code> decorator is used as a prescription for the size of the box that Batch should run the job on; please be sure that this resource requirement can be met. See <a href="/v/r/metaflow/scaling#my-job-is-stuck-in-runnable-state-what-do-i-do">here</a> on what can happen if this is not the case.</p><p>In addition to <code>cpu</code> and <code>memory</code> you can specify <code>gpu=N</code> to request N GPUs for the instance.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="using-aws-batch-selectively-with-batch-decorator">Using AWS Batch selectively with <code>batch</code> decorator<a class="hash-link" href="#using-aws-batch-selectively-with-batch-decorator" title="Direct link to heading">â€‹</a></h3><p>A close relative of the <code>resources</code> decorator is <code>batch</code>. It takes exactly the same keyword arguments as <code>resources</code> but instead of being a mere suggestion, it forces the step to be run on AWS Batch.</p><p>The main benefit of <code>batch</code> is that you can selectively run some steps locally and some on AWS Batch. In the example above, try replacing <code>resources</code> with <code>batch</code> and run it again.</p><p>You will see that the <code>start</code> step gets executed on an AWS Batch instance but the <code>end</code> step, which does not need special resources, is executed locally without the additional latency of launching a AWS Batch job. Executing a <a href="/v/r/metaflow/basics#foreach"><code>foreach</code></a> step launches parallel AWS Batch jobs with the specified resources for the step.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="aws-batch-tips-and-tricks">AWS Batch tips and tricks<a class="hash-link" href="#aws-batch-tips-and-tricks" title="Direct link to heading">â€‹</a></h3><p>Here are some useful tips and tricks related to running Metaflow on AWS Batch.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="how-much-resources-can-i-request"><strong>How much <code>resources</code> can I request?</strong><a class="hash-link" href="#how-much-resources-can-i-request" title="Direct link to heading">â€‹</a></h4><p>Here are the current defaults for different resource types:</p><ul><li><code>cpu</code>: 1</li><li><code>memory</code>: 4000 <!-- -->(<!-- -->4GB<!-- -->)</li></ul><p>When setting <code>resources</code>, keep in mind the configuration of your AWS Batch Compute Environment. Your job will be stuck in a <code>RUNNABLE</code> state if AWS is unable to provision the requested resources. Additionally, as a good measure, don&#x27;t request more resources than what your workflow actually needs. On the other hand, never optimize resources prematurely.</p><p>You can place your AWS Batch task in a specific queue by using the <code>queue</code> argument. By default, all tasks execute on an appropriate <a href="https://hub.docker.com/r/rocker/ml" target="_blank" rel="noopener noreferrer">Rocker docker image</a>, unless overridden by the <code>image</code> argument.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="my-job-is-stuck-in-runnable-state-what-do-i-do">My job is stuck in <code>RUNNABLE</code> state. What do I do?<a class="hash-link" href="#my-job-is-stuck-in-runnable-state-what-do-i-do" title="Direct link to heading">â€‹</a></h4><p>Consult <a href="https://docs.aws.amazon.com/batch/latest/userguide/troubleshooting.html#job_stuck_in_runnable" target="_blank" rel="noopener noreferrer">this article</a>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="listing-and-killing-aws-batch-tasks"><strong>Listing and killing AWS Batch tasks</strong><a class="hash-link" href="#listing-and-killing-aws-batch-tasks" title="Direct link to heading">â€‹</a></h4><p>If you interrupt a Metaflow run, any AWS Batch tasks launched by the run get killed by Metaflow automatically. Even if something went wrong during the final cleanup, the tasks will finish and die eventually, at the latest when they hit the maximum time allowed for an AWS Batch task.</p><p>If you want to make sure you have no AWS Batch tasks running, or you want to manage them manually, you can use the <code>batch list</code> and <code>batch kill</code> commands. These commands are disabled in the <a href="/v/r/metaflow-on-aws/metaflow-sandbox">Metaflow AWS Sandbox</a>.</p><p>You can easily see what AWS Batch tasks were launched by your latest run with</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R batch list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = &quot;list&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>You can kill the tasks started by the latest run with</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R batch </span><span class="token function" style="color:#d73a49">kill</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = &quot;kill&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>If you have started multiple runs, you can make sure there are no orphaned tasks still running with</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R batch list --my-runs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = &quot;list&quot;, my_runs = TRUE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>You can kill the tasks started by the latest run with</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R batch </span><span class="token function" style="color:#d73a49">kill</span><span class="token plain"> --my-runs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = &quot;kill&quot;, my_runs = TRUE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>If you see multiple runs running, you can cherry-pick a specific job, e.g. 456, to be killed as follows</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R batch </span><span class="token function" style="color:#d73a49">kill</span><span class="token plain"> --run-id </span><span class="token number" style="color:#36acaa">456</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = &quot;kill&quot;, run_id = &quot;456&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>If you are working with another person, you can see and kill their tasks related to this flow with</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R batch </span><span class="token function" style="color:#d73a49">kill</span><span class="token plain"> --user savin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(batch = &quot;kill&quot;, user = &quot;savin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>Note that all the above commands only affect the flow defined in your script. You can work on many flows in parallel and be confident that <code>kill</code> kills tasks only related to the flow you called <code>kill</code> with.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="safeguard-flags"><strong>Safeguard flags</strong><a class="hash-link" href="#safeguard-flags" title="Direct link to heading">â€‹</a></h4><p>It is almost too easy to launch AWS Batch jobs with Metaflow. A foreach branch with <code>1000</code> parameters would launch 1000 parallel Batch instances which may turn out to be quite expensive.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_BvAR">myflow.R</div><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">a </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">- function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  self</span><span class="token variable" style="color:#36acaa">$params</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">- range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1,1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;params&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To safeguard against inadvertent launching of many parallel Batch jobs, the <code>run</code> and <code>resume</code> commands have a flag <code>--max-num-splits</code> which fails the task if it attempts to launch more than 100 splits by default. Use the flag to increase the limit if you actually need more tasks.</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R run --max-num-splits </span><span class="token number" style="color:#36acaa">200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(max_num_splits = 200)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><p>Another flag, <code>--max-workers</code>, limits the number of tasks run in parallel. Even if a foreach launched 100 splits, <code>--max-workers</code> would make only 16 <!-- -->(<!-- -->by default<!-- -->)<!-- --> of them run in parallel at any point in time. If you want more parallelism, increase the value of <code>--max-workers</code>.</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript myflow.R run --max-workers </span><span class="token number" style="color:#36acaa">32</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in myflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(max_workers = 32)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="accessing-aws-batch-logs"><strong>Accessing AWS Batch logs</strong><a class="hash-link" href="#accessing-aws-batch-logs" title="Direct link to heading">â€‹</a></h4><p>As a convenience feature, you can also see the logs of any past step as follows:</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RStudio</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript bigsumflow.R logs </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">/end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in bigsumflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(logs = &quot;15/end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="disk-space">Disk space<a class="hash-link" href="#disk-space" title="Direct link to heading">â€‹</a></h3><p>You can request higher disk space on AWS Batch instances by using an unmanaged Compute Environment with a custom AMI.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="large-data-artifacts">Large data artifacts<a class="hash-link" href="#large-data-artifacts" title="Direct link to heading">â€‹</a></h3><p>Metaflow uses Python&#x27;s default object serialization format, <a href="https://docs.python.org/3/library/pickle.html" target="_blank" rel="noopener noreferrer">Pickle</a>, to persist data artifacts.</p><p>Unfortunately Python was not able to pickle objects larger than 2GB prior to Python 3.5. If you need to store large data artifacts, such as a large data frame, using a recent version of Python 3 is highly recommended.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.dev/Netflix/metaflow-docs/blob/new-docs/docs/v/r/metaflow/scaling.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/v/r/metaflow/debugging"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Debugging with Metaflow</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/v/r/metaflow/failures"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Dealing with Failures</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#requesting-resources-with-resources-decorator" class="table-of-contents__link toc-highlight">Requesting resources with <code>resources</code> decorator</a></li><li><a href="#using-aws-batch" class="table-of-contents__link toc-highlight">Using AWS Batch</a><ul><li><a href="#using-aws-batch-selectively-with-batch-decorator" class="table-of-contents__link toc-highlight">Using AWS Batch selectively with <code>batch</code> decorator</a></li><li><a href="#aws-batch-tips-and-tricks" class="table-of-contents__link toc-highlight">AWS Batch tips and tricks</a></li><li><a href="#disk-space" class="table-of-contents__link toc-highlight">Disk space</a></li><li><a href="#large-data-artifacts" class="table-of-contents__link toc-highlight">Large data artifacts</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.9f38e140.js"></script>
<script src="/assets/js/main.871dc34a.js"></script>
</body>
</html>