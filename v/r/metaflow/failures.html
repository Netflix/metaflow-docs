<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-v/r/metaflow/failures">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EYFXNGNGB6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EYFXNGNGB6",{anonymize_ip:!0})</script><title data-rh="true">Dealing with Failures | Metaflow Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.metaflow.org/img/og-metaflow.png"><meta data-rh="true" name="twitter:image" content="https://docs.metaflow.org/img/og-metaflow.png"><meta data-rh="true" property="og:url" content="https://docs.metaflow.org/v/r/metaflow/failures"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="og:width" content="200"><meta data-rh="true" name="og:height" content="126"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Dealing with Failures | Metaflow Docs"><meta data-rh="true" name="description" content="Failures are a natural, expected part of data science workflows. Here are some typical"><meta data-rh="true" property="og:description" content="Failures are a natural, expected part of data science workflows. Here are some typical"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.metaflow.org/v/r/metaflow/failures"><link data-rh="true" rel="alternate" href="https://docs.metaflow.org/v/r/metaflow/failures" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.metaflow.org/v/r/metaflow/failures" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://5IZ8L9TJQL-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.57e5c9db.css">
<link rel="preload" href="/assets/js/runtime~main.f6664218.js" as="script">
<link rel="preload" href="/assets/js/main.99e0c1a5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_jvwV"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Metaflow_Logo_Horizontal_OneColor_DarkBlue_RGB.svg" alt="Metaflow Logo" class="themedImage_ToTc themedImage--light_HNdA" height="30"><img src="/img/Metaflow_Logo_Horizontal_OneColor_White_RGB.svg" alt="Metaflow Logo" class="themedImage_ToTc themedImage--dark_i4oU" height="30"></div></a><a class="navbar__item navbar__link" href="/">Documentation</a><a href="https://outerbounds.com/docs/admin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Deployment Guide<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div style="display:flex;align-items:center"><div class="responsivePadding_cpaU" style="display:flex;align-items:center;gap:0.75rem"><a href="https://github.com/Netflix/metaflow" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><img src="/img/github.svg" alt="GitHub" class="logo_v_H3 githubLogo"></a><a href="http://slack.outerbounds.co/" target="_blank" rel="noopener noreferrer" aria-label="Slack"><img class="logo_v_H3" src="/img/slack.svg" alt="Slack"></a></div><div class="toggle_vylO colorModeToggle_x44X"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Dealing with Failures</h1><p>Failures are a natural, expected part of data science workflows. Here are some typical
reasons why you can expect your workflow to fail:</p><ol><li><strong>Misbehaving code:</strong> no code is perfect. Your code may fail to handle edge cases or
libraries behave differently than what you expected.</li><li><strong>Unanticipated issues with data:</strong> data is harder than science. Data is how Metaflow
workflows interact with the chaotic, high entropy, outside world. It is practically
impossible to anticipate all possible ways the input data can be broken.</li><li><strong>Platform issues:</strong> the best infrastructure is invisible. Unfortunately, every now
and then platforms that Metaflow relies on, or Metaflow itself, make their existence
painfully obvious by failing in creative ways.</li></ol><p>Metaflow provides straightforward tools for you to handle all these scenarios. If you
are in a hurry, see <a href="/v/r/metaflow/failures#summary">a quick summary of the tools</a>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="retrying-tasks-with-the-retry-decorator">Retrying Tasks with the <code>retry</code> Decorator<a class="hash-link" href="#retrying-tasks-with-the-retry-decorator" title="Direct link to heading">​</a></h2><p>Retrying a failed task is the simplest way to try to handle errors. It is a particularly
effective strategy with platform issues which are typically transient in nature.</p><p>You can enable retries for a step simply by adding <code>retry</code> decorator in the step, like
here:</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">retryflow.R</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">library(metaflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start &lt;- function(self){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n &lt;- rbinom(n=1, size=1, prob=0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (n==0){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop(&quot;Bad Luck!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(&quot;Lucky you!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end &lt;- function(self){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;Phew!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metaflow(&quot;RetryFlow&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step=&quot;start&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         decorator(&quot;retry&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         r_function=start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         next_step=&quot;end&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step=&quot;end&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         r_function=end) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When you run this flow, you will see that sometimes it succeeds without a hitch but
sometimes the <code>start</code> step raises an exception and needs to be retried. By default,
<code>retry</code> retries the step three times. Thanks to <code>retry</code>, this workflow will almost
always succeed.</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:16.653 [181/start/1076 (pid 54076)] Task is starting.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:22.441 [181/start/1076 (pid 54076)] Evaluation error: Bad Luck!.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:23.408 [181/start/1076 (pid 54076)] Task failed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:23.602 [181/start/1076 (pid 54106)] Task is starting (retry).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:29.434 [181/start/1076 (pid 54106)] Evaluation error: Bad Luck!.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:30.665 [181/start/1076 (pid 54106)] Task failed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:30.902 [181/start/1076 (pid 54139)] Task is starting (retry).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:34.704 [181/start/1076 (pid 54139)] [1] &quot;Lucky you!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-06-19 15:48:38.545 [181/start/1076 (pid 54139)] Task finished successfully.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is highly recommended that you use <code>retry</code> every time you run your flow on the
<a href="/v/r/metaflow-on-aws">cloud</a>. Instead of annotating every step with a
retry decorator, you can also automatically add a retry decorator to all steps that do
not have one as follows:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">RStudio</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript retryflow.R run --with retry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in retryflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(with = c(&quot;retry&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-to-prevent-retries">How to Prevent Retries<a class="hash-link" href="#how-to-prevent-retries" title="Direct link to heading">​</a></h3><p>If retries are such a good idea, why not enable them by default for all steps? First,
retries only help with transient errors, like sporadic platform issues. If the input
data or your code is broken, retrying will not help anything. Secondly, not all steps
can be retried safely.</p><p>Imagine a hypothetical step like this:</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">moneyflow.R</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">withdraw_money_from_account &lt;- function(self){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    library(httr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r &lt;- POST(&#x27;bank.com/account/123/withdraw&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                body=list(amount = 1000))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you run this code with:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Terminal</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">RStudio</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Rscript moneyflow.R run --with retry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Replace run() in moneyflow.R with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># run(with = c(&quot;retry&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># and execute in RStudio</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><p>you may end up withdrawing up to $4000 instead of the intended $1000. To make sure no
one will accidentally retry a step with <em>destructive side effects</em> like this, you should
add <code>times=0</code> in the step code:</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">moneyflow.R</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">metaflow(&quot;MoneyFlow&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step=&quot;withdraw&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         decorator(&quot;retry&quot;, times=0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         r_function=withdraw_money_from_account,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         next_step=&quot;end&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now the code can be safely rerun, even using <code>--with retry</code>. All other steps will be
retried as usual.</p><p>Most data science workflows do not have to worry about this. As long as your step only
reads and writes Metaflow artifacts and/or performs only read-only operations with
external systems <!-- -->(<!-- -->e.g. performs only <code>SELECT</code> queries, no <code>INSERT</code>s etc.<!-- -->)<!-- -->, your step
is <a href="https://en.wikipedia.org/wiki/Idempotence#Computer_science_meaning" target="_blank" rel="noopener noreferrer">idempotent</a> and
can be retried without concern.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="maximizing-safety">Maximizing Safety<a class="hash-link" href="#maximizing-safety" title="Direct link to heading">​</a></h3><p>By default, <code>retry</code> will retry the step for three times before giving up. It waits for 2
minutes between retries on the <a href="/v/r/metaflow-on-aws">cloud</a>. This
means that if your code fails fast, any transient platform issues need to get resolved
in less than 10 minutes or the whole run will fail. 10 minutes is typically more than
enough, but sometimes you want both a belt and suspenders.</p><p>If you have a sensitive production workflow which should not fail easily, there are four
things you can do:</p><ol><li>You can increase the number of retries to <code>times=4</code>, which is the maximum number of
retries currently.</li><li>You can make the time between retries arbitrarily long, e.g. <code>times=4,
minutes_between_retries=20.</code> This will give the task over an hour to succeed.</li><li>You can use <code>catch</code>, described below, as a way to continue even after all retries
have failed.</li></ol><p>You can use any combination of these four techniques, or all of them together, to build
rock-solid workflows.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="results-of-retries">Results of Retries<a class="hash-link" href="#results-of-retries" title="Direct link to heading">​</a></h3><p>If the same code is executed multiple times by <code>retry</code>, are there going to be duplicate
artifacts? No, Metaflow manages retries so that only artifacts from the last retry are
visible. If you use <a href="/v/r/metaflow/client">the Client API </a>to inspect results, you don&#x27;t have to do
anything special to deal with retries that may have happened. Each task will have only
one set of results. Correspondingly, the logs returned by <code>task</code> show the output of the
last attempt only.</p><p>If you want to know if a task was retried, you can retrieve retry timestamps from <code>Task</code>
metadata:</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">task &lt;- task_client$new(&quot;RetryFlow/181/start/1076&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(task$metadata_dict$attempt)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="catching-exceptions-with-the-catch-decorator">Catching Exceptions with the <code>catch</code> Decorator<a class="hash-link" href="#catching-exceptions-with-the-catch-decorator" title="Direct link to heading">​</a></h2><p>As mentioned above, <code>retry</code> is an appropriate tool for dealing with transient issues.
What about issues that are not transient? Metaflow has another decorator, <code>catch</code> that
catches any exceptions that occur during the step and then continues execution of
subsequent steps.</p><p>The main upside of <code>catch</code> is that it can make your workflows extremely robust: it will
handle all error scenarios from faulty code and faulty data to platform issues. The main
downside is that your code needs to be modified so that it can tolerate faulty steps.</p><p>Let&#x27;s consider issues caused by your code versus everything surrounding it separately.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="exceptions-raised-by-your-code">Exceptions Raised by Your Code<a class="hash-link" href="#exceptions-raised-by-your-code" title="Direct link to heading">​</a></h3><p>By default, Metaflow stops execution of the flow when a step fails. It can&#x27;t know what
to do with failed steps automatically.</p><p>You may know that some steps are error-prone. For instance, this can happen with a step
inside a foreach loop that iterates over unknown data, such as the results of a query or
a parameter matrix. In this case, it may be desirable to let some tasks fail without
crashing the whole flow.</p><p>Consider this example that is structured like a hyperparameter search:</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">library(metaflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start &lt;- function(self){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self$params &lt;- c(-1, 2, 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sanity_check &lt;- function(self){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(self$input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (self$input &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop(&quot;input cannot be negative&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">join &lt;- function(self, inputs){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (input in inputs){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!is.null(input$compute_failed)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           print(paste0(&quot;Exception happened for param: &quot;, input$input))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           print(&quot;Exception message:&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           print(input$compute_failed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metaflow(&quot;CatchFlow&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step = &quot;start&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         r_function = start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         next_step = &quot;sanity_check&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         foreach = &quot;params&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step = &quot;sanity_check&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         decorator(&quot;catch&quot;, var=&quot;compute_failed&quot;, print_exception=FALSE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         r_function = sanity_check,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         next_step = &quot;join&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step = &quot;join&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         r_function = join,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         next_step = &quot;end&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         join = TRUE) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step(step = &quot;end&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can guess, the above flow raises an error. Normally, this would crash the whole
flow. However, in this example the <code>catch</code> decorator catches the exception and stores it
in an instance variable called <code>compute_failed</code>, and lets the execution continue. The
next step, <code>join</code>, contains logic to handle the exception.</p><p>The <code>var</code> argument is optional. The exception is not stored unless you specify it. You
can also specify <code>print_exception=FALSE</code> to prevent the <code>catch</code> decorator from printing
out the caught exception on stdout.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="platform-exceptions">Platform Exceptions<a class="hash-link" href="#platform-exceptions" title="Direct link to heading">​</a></h3><p>You could have dealt with the above error by wrapping the whole step in a <code>tryCatch</code>
block. In effect, this is how <code>catch</code> deals with errors raised in the user code.</p><p>In contrast, platform issues happen outside of your code, so you can&#x27;t handle them with
a <code>tryCatch</code> block. For instance, an AWS Batch container may fail to start, a server the
step runs on may fail abruptly, or your code may get killed if it uses too much memory.</p><p>Let&#x27;s simulate a platform issue like these with the following flow that kills itself
without giving R a chance to recover:</p><div class="language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">library(metaflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start &lt;- function(self) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  library(tools)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pskill(Sys.getpid())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end &lt;- function(self) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Error is : &quot;, self$start_failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metaflow(&quot;SuicidalFlowR&quot;) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decorator(&quot;catch&quot;, var = &quot;start_failed&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decorator(&quot;retry&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step = &quot;start&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r_function = start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    next_step = &quot;end&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step = &quot;end&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r_function = end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ) %&gt;%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that we use both <code>retry</code> and <code>catch</code> above. <code>retry</code> attempts to run the step three
times, hoping that the issue is transient. The hope is futile. The task kills itself
every time.</p><p>After all retries are exhausted, <code>catch</code> takes over and records an exception in
<code>start_failed</code>, notifying that all attempts to run <code>start</code> failed. Now it is up to the
subsequent steps, <code>end</code> in this case, to deal with the scenario that <code>start</code> produced no
results whatsoever. They can choose an alternative code path using the variable assigned
by <code>catch</code>, <code>start_failed</code> in this example.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>Here is a quick summary of failure handling in Metaflow:</p><ul><li>Use <code>retry</code> to deal with transient platform issues. You can do this easily on the
command line with the <code>--with retry</code> option.</li><li>Use <code>retry</code> <strong>with</strong> <code>catch</code> for extra robustness if you have modified your code to
deal with faulty steps which are handled by <code>catch</code>.</li><li>Use <code>catch</code> <strong>without</strong> <code>retry</code> to handle steps <a href="/v/r/metaflow/failures#how-to-prevent-retries">that can&#x27;t be retried
safely</a>. It is a good idea to use <code>times=0</code> for
<code>retry</code> in this case.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.dev/Netflix/metaflow-docs/blob/master/docs/v/r/metaflow/failures.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#retrying-tasks-with-the-retry-decorator" class="table-of-contents__link toc-highlight">Retrying Tasks with the <code>retry</code> Decorator</a><ul><li><a href="#how-to-prevent-retries" class="table-of-contents__link toc-highlight">How to Prevent Retries</a></li><li><a href="#maximizing-safety" class="table-of-contents__link toc-highlight">Maximizing Safety</a></li><li><a href="#results-of-retries" class="table-of-contents__link toc-highlight">Results of Retries</a></li></ul></li><li><a href="#catching-exceptions-with-the-catch-decorator" class="table-of-contents__link toc-highlight">Catching Exceptions with the <code>catch</code> Decorator</a><ul><li><a href="#exceptions-raised-by-your-code" class="table-of-contents__link toc-highlight">Exceptions Raised by Your Code</a></li><li><a href="#platform-exceptions" class="table-of-contents__link toc-highlight">Platform Exceptions</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.f6664218.js"></script>
<script src="/assets/js/main.99e0c1a5.js"></script>
</body>
</html>